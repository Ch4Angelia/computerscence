<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Sleep Tracker</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans",Helvetica,Arial;line-height:1.45}
    body{max-width:900px;margin:28px auto;padding:18px;background:#f7f8fb;border-radius:12px;box-shadow:0 6px 20px rgba(50,50,93,0.06)}
    h1{font-size:1.5rem;margin-bottom:6px}
    .card{background:white;padding:16px;border-radius:10px;margin-bottom:14px;box-shadow:0 2px 8px rgba(30,30,60,0.04)}
    label{display:block;margin:8px 0 6px;font-weight:600}
    input,select,button{padding:10px;border-radius:8px;border:1px solid #e3e6ee;outline:none;font-size:0.95rem}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .grow{flex:1}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid #f0f2f7;text-align:left}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700}
    .ok{background:#e6ffef;color:#0b8a4a}
    .warn{background:#fff4e6;color:#9a4a00}
    .danger{background:#ffe8ea;color:#9a1f2b}
    .muted{color:#6f7480;font-size:0.95rem}
    .center{text-align:center}
    .actions{display:flex;gap:8px}
    .small{font-size:0.85rem;padding:6px 8px}
    .danger-btn{background:#ffecf0;border:1px solid #ffb6c1}
    @media (max-width:600px){.row{flex-direction:column}}
  </style>
</head>
<body>
  <h1>Sleep Tracker</h1>
  <div class="card">
    <div class="muted">Your age was loaded from the homepage. Enter your sleep and wake times; the system will calculate total sleep hours and compare them with recommended values.</div>

    <div class="row" style="margin-top:10px">
      <div class="grow">
        <label for="sleepStart">Sleep Time</label>
        <input id="sleepStart" type="datetime-local">
      </div>
      <div class="grow">
        <label for="sleepEnd">Wake Time</label>
        <input id="sleepEnd" type="datetime-local">
      </div>
    </div>

    <div style="margin-top:12px" class="row">
      <button id="addBtn">Add Record</button>
      <button id="clearBtn" class="danger-btn small">Clear All Records</button>
    </div>
  </div>

  <div class="card">
    <div id="summary" class="muted">No records yet.</div>
    <div id="alertBox" style="margin-top:8px"></div>
    <table id="recordsTable">
      <thead>
        <tr><th>Date</th><th>Sleep → Wake</th><th>Total Hours</th><th>Recommendation</th><th class="center">Action</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // Recommended sleep hours (hours)
    const recommendations = {
      toddler: {min:11, max:14, label:'11–14 hrs'},
      child: {min:9, max:11, label:'9–11 hrs'},
      teen: {min:8, max:10, label:'8–10 hrs'},
      adult: {min:7, max:9, label:'7–9 hrs'},
      older: {min:7, max:8, label:'7–8 hrs'}
    };

    // Load user age from homepage
    const userAge = Number(localStorage.getItem('userAge') || 18);

    function getAgeGroup(age){
      if(age >= 65) return 'older';
      if(age >= 18) return 'adult';
      if(age >= 14) return 'teen';
      if(age >= 6) return 'child';
      return 'toddler';
    }

    const sleepStart = document.getElementById('sleepStart');
    const sleepEnd = document.getElementById('sleepEnd');
    const addBtn = document.getElementById('addBtn');
    const clearBtn = document.getElementById('clearBtn');
    const recordsTableBody = document.querySelector('#recordsTable tbody');
    const summary = document.getElementById('summary');
    const alertBox = document.getElementById('alertBox');

    let records = JSON.parse(localStorage.getItem('sleepRecords') || '[]');
    render();

    addBtn.addEventListener('click', () => {
      alertBox.innerHTML = '';
      const s = sleepStart.value; const e = sleepEnd.value; const age = getAgeGroup(userAge);
      if(!s || !e){ return showToast('Please fill in both sleep and wake times.'); }

      const start = new Date(s);
      const end = new Date(e);
      if(isNaN(start) || isNaN(end)) return showToast('Invalid time format.');

      let diffMs = end - start;
      if(diffMs < 0){ diffMs += 24*60*60*1000; }
      const hours = Math.round((diffMs/1000/60/60) * 100) / 100;

      const rec = recommendations[age];

      const item = {id: Date.now(), start:s, end:e, hours, age};
      records.unshift(item);
      localStorage.setItem('sleepRecords', JSON.stringify(records));
      render();

      if(hours < rec.min){
        showWarning(`⚠️ You slept ${hours} hrs. Recommended: ${rec.label}. Try getting more rest.`);
      } else if(hours <= rec.max){
        showOK(`✅ You slept ${hours} hrs, within the recommended range (${rec.label}).`);
      } else {
        showOK(`✅ You slept ${hours} hrs, above the recommended range (${rec.label}).`);
      }

    });

    clearBtn.addEventListener('click', ()=>{
      if(!confirm('Are you sure you want to clear all records?')) return;
      records = []; localStorage.removeItem('sleepRecords'); render();
    });

    function render(){
      recordsTableBody.innerHTML = '';
      if(records.length === 0){ summary.innerText = 'No records yet.'; return; }

      const latest = records[0];
      const rec = recommendations[latest.age];
      summary.innerText = `Latest: ${formatDate(new Date(latest.start))}, slept ${latest.hours} hrs. Recommended: ${rec.label}`;

      for(const r of records){
        const tr = document.createElement('tr');
        const s = new Date(r.start);
        const e = new Date(r.end);
        const dateTxt = formatDate(s);
        const timesTxt = formatTime(s) + ' → ' + formatTime(e);
        const recLabel = recommendations[r.age].label;

        tr.innerHTML = `
          <td>${dateTxt}</td>
          <td>${timesTxt}</td>
          <td>${r.hours} hrs</td>
          <td>${recLabel}</td>
          <td class="center"><div class="actions"><button class="small" data-id="${r.id}">Delete</button></div></td>
        `;
        recordsTableBody.appendChild(tr);
      }

      recordsTableBody.querySelectorAll('button[data-id]').forEach(btn => {
        btn.addEventListener('click', ()=>{
          const id = Number(btn.getAttribute('data-id'));
          records = records.filter(x=>x.id !== id);
          localStorage.setItem('sleepRecords', JSON.stringify(records));
          render();
        });
      });
    }

    function formatDate(d){ return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()); }
    function formatTime(d){ return pad(d.getHours()) + ':' + pad(d.getMinutes()); }
    function pad(n){return String(n).padStart(2,'0');}

    function showToast(msg){ alertBox.innerHTML = `<div class="warn badge">${escapeHtml(msg)}</div>`; }
    function showWarning(msg){ alertBox.innerHTML = `<div class="warn badge">${escapeHtml(msg)}</div>`; setTimeout(()=>{ alert(msg); }, 50);}